(function(){"use strict";(function(t){function e(){}e.prototype.encode=function(r){for(var i=[],a=r.length,o=0;o<a;){var s=r.codePointAt(o),f=0,c=0;for(s<=127?(f=0,c=0):s<=2047?(f=6,c=192):s<=65535?(f=12,c=224):s<=2097151&&(f=18,c=240),i.push(c|s>>f),f-=6;f>=0;)i.push(128|s>>f&63),f-=6;o+=s>=65536?2:1}return i},globalThis.TextEncoder=e,t.TextEncoder||(t.TextEncoder=e);function n(){}n.prototype.decode=function(r){if(!r)return"";for(var i="",a=0;a<r.length;){var o=r[a],s=0,f=0;if(o<=127?(s=0,f=o&255):o<=223?(s=1,f=o&31):o<=239?(s=2,f=o&15):o<=244&&(s=3,f=o&7),r.length-a-s>0)for(var c=0;c<s;)o=r[a+c+1],f=f<<6|o&63,c+=1;else f=65533,s=r.length-a;i+=String.fromCodePoint(f),a+=s+1}return i},globalThis.TextDecoder=n,t.TextDecoder||(t.TextDecoder=n)})(typeof globalThis>"u"?typeof global>"u"?typeof self>"u"?void 0:self:global:globalThis);let u;const _=new Array(128).fill(void 0);_.push(void 0,null,!0,!1);let l=_.length;function T(t){l===_.length&&_.push(_.length+1);const e=l;return l=_[e],_[e]=t,e}function d(t){return _[t]}function M(t){t<132||(_[t]=l,l=t)}function p(t){const e=d(t);return M(t),e}const v=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&v.decode();let h=null;function y(){return(h===null||h.byteLength===0)&&(h=new Uint8Array(u.memory.buffer)),h}function A(t,e){return t=t>>>0,v.decode(y().subarray(t,t+e))}function O(){u.set_panic_hook()}let b=null;function k(){return(b===null||b.byteLength===0)&&(b=new Float32Array(u.memory.buffer)),b}let g=0;function D(t,e){const n=e(t.length*4,4)>>>0;return k().set(t,n/4),g=t.length,n}const m=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},S=typeof m.encodeInto=="function"?function(t,e){return m.encodeInto(t,e)}:function(t,e){const n=m.encode(t);return e.set(n),{read:t.length,written:n.length}};function F(t,e,n){if(n===void 0){const s=m.encode(t),f=e(s.length,1)>>>0;return y().subarray(f,f+s.length).set(s),g=s.length,f}let r=t.length,i=e(r,1)>>>0;const a=y();let o=0;for(;o<r;o++){const s=t.charCodeAt(o);if(s>127)break;a[i+o]=s}if(o!==r){o!==0&&(t=t.slice(o)),i=n(i,r,r=o+t.length*3,1)>>>0;const s=y().subarray(i+o,i+r),f=S(t,s);o+=f.written}return g=o,i}let w=null;function E(){return(w===null||w.byteLength===0)&&(w=new Int32Array(u.memory.buffer)),w}class x{static __wrap(e){e=e>>>0;const n=Object.create(x.prototype);return n.__wbg_ptr=e,n}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();u.__wbg_tuner_free(e)}static new(e,n,r,i,a,o){const s=u.tuner_new(e,n,r,i,a,o);return x.__wrap(s)}process_input(e){const n=D(e,u.__wbindgen_malloc),r=g,i=u.tuner_process_input(this.__wbg_ptr,n,r);return p(i)}get_wheel_freq(){return u.tuner_get_wheel_freq(this.__wbg_ptr)}toggle_filter(e){u.tuner_toggle_filter(this.__wbg_ptr,e)}get_positions(){const e=u.tuner_get_positions(this.__wbg_ptr);return p(e)}get_last_pitch(){return u.tuner_get_last_pitch(this.__wbg_ptr)}update_params(e,n,r,i){u.tuner_update_params(this.__wbg_ptr,e,n,r,i)}get_input_buffer(){const e=u.tuner_get_input_buffer(this.__wbg_ptr);return p(e)}get_output_buffer(){const e=u.tuner_get_output_buffer(this.__wbg_ptr);return p(e)}}async function R(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function B(){const t={};return t.wbg={},t.wbg.__wbindgen_number_new=function(e){return T(e)},t.wbg.__wbindgen_object_drop_ref=function(e){p(e)},t.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return T(e)},t.wbg.__wbg_stack_658279fe44541cf6=function(e,n){const r=d(n).stack,i=F(r,u.__wbindgen_malloc,u.__wbindgen_realloc),a=g;E()[e/4+1]=a,E()[e/4+0]=i},t.wbg.__wbg_error_f851667af71bcfc6=function(e,n){let r,i;try{r=e,i=n,console.error(A(e,n))}finally{u.__wbindgen_free(r,i,1)}},t.wbg.__wbg_new_ffc6d4d085022169=function(){const e=new Array;return T(e)},t.wbg.__wbg_push_901f3914205d44de=function(e,n){return d(e).push(d(n))},t.wbg.__wbindgen_throw=function(e,n){throw new Error(A(e,n))},t}function I(t,e){return u=t.exports,W.__wbindgen_wasm_module=e,b=null,w=null,h=null,u}async function W(t){if(u!==void 0)return u;typeof t>"u"&&(t=new URL("/assets/strobe_tuner_bg-BCIDzoGB.wasm",self.location.href));const e=B();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await R(await t,e);return I(n,r)}class L extends AudioWorkletProcessor{constructor(){super(),this.port.onmessage=e=>this.onmessage(e.data),this.tuner=null,console.log("New Tuner created")}process(e,n){const i=e[0][0];let a=this.tuner?this.tuner.process_input(i):i;for(let o=0;o<a.length;o++)n[0][0][o]=a[o];return!0}onmessage(e){switch(e.type){case"send-wasm-module":W(WebAssembly.compile(e.wasmBytes)).then(()=>{this.port.postMessage({type:"wasm-module-loaded"}),console.log("Loaded WASM module")});break;case"init-tuner":O(),this.tuner=x.new(e.sampleRate,e.wheelFrequency,128,e.filterOn,e.filterOctave,e.filterQ);break;case"get-frame":if(!this.tuner)break;this.port.postMessage({type:"frame",frame:{inputBuffer:this.tuner.get_input_buffer(),outputBuffer:this.tuner.get_output_buffer(),positionBuffer:this.tuner.get_positions(),pitch:this.tuner.get_last_pitch()}});break;case"update-settings":console.log(e),this.tuner.update_params(e.wheelFrequency,e.filterOn,e.filterOctave,e.filterQ);break;default:console.error(e.type+" is not a supported message to tuner")}}}registerProcessor("TunerProcessor",L)})();
