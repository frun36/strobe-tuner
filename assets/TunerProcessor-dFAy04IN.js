(function(){"use strict";(function(t){function e(){}e.prototype.encode=function(r){for(var s=[],a=r.length,o=0;o<a;){var i=r.codePointAt(o),u=0,c=0;for(i<=127?(u=0,c=0):i<=2047?(u=6,c=192):i<=65535?(u=12,c=224):i<=2097151&&(u=18,c=240),s.push(c|i>>u),u-=6;u>=0;)s.push(128|i>>u&63),u-=6;o+=i>=65536?2:1}return s},globalThis.TextEncoder=e,t.TextEncoder||(t.TextEncoder=e);function n(){}n.prototype.decode=function(r){if(!r)return"";for(var s="",a=0;a<r.length;){var o=r[a],i=0,u=0;if(o<=127?(i=0,u=o&255):o<=223?(i=1,u=o&31):o<=239?(i=2,u=o&15):o<=244&&(i=3,u=o&7),r.length-a-i>0)for(var c=0;c<i;)o=r[a+c+1],u=u<<6|o&63,c+=1;else u=65533,i=r.length-a;s+=String.fromCodePoint(u),a+=i+1}return s},globalThis.TextDecoder=n,t.TextDecoder||(t.TextDecoder=n)})(typeof globalThis>"u"?typeof global>"u"?typeof self>"u"?void 0:self:global:globalThis);let f;const _=new Array(128).fill(void 0);_.push(void 0,null,!0,!1);let p=_.length;function y(t){p===_.length&&_.push(_.length+1);const e=p;return p=_[e],_[e]=t,e}const E=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&E.decode();let g=null;function m(){return(g===null||g.byteLength===0)&&(g=new Uint8Array(f.memory.buffer)),g}function A(t,e){return t=t>>>0,E.decode(m().subarray(t,t+e))}function x(t){return _[t]}function O(t){t<132||(_[t]=p,p=t)}function l(t){const e=x(t);return O(t),e}function k(){f.set_panic_hook()}let b=null;function F(){return(b===null||b.byteLength===0)&&(b=new Float32Array(f.memory.buffer)),b}let h=0;function S(t,e){const n=e(t.length*4,4)>>>0;return F().set(t,n/4),h=t.length,n}const T=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},D=typeof T.encodeInto=="function"?function(t,e){return T.encodeInto(t,e)}:function(t,e){const n=T.encode(t);return e.set(n),{read:t.length,written:n.length}};function L(t,e,n){if(n===void 0){const i=T.encode(t),u=e(i.length,1)>>>0;return m().subarray(u,u+i.length).set(i),h=i.length,u}let r=t.length,s=e(r,1)>>>0;const a=m();let o=0;for(;o<r;o++){const i=t.charCodeAt(o);if(i>127)break;a[s+o]=i}if(o!==r){o!==0&&(t=t.slice(o)),s=n(s,r,r=o+t.length*3,1)>>>0;const i=m().subarray(s+o,s+r),u=D(t,i);o+=u.written}return h=o,s}let w=null;function M(){return(w===null||w.byteLength===0)&&(w=new Int32Array(f.memory.buffer)),w}let d=null;function R(){return(d===null||d.byteLength===0)&&(d=new Uint32Array(f.memory.buffer)),d}function U(t,e){t=t>>>0;const r=R().subarray(t/4,t/4+e),s=[];for(let a=0;a<r.length;a++)s.push(l(r[a]));return s}class v{static __wrap(e){e=e>>>0;const n=Object.create(v.prototype);return n.__wbg_ptr=e,n}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();f.__wbg_tuner_free(e)}static new(e,n,r,s,a,o){const i=f.tuner_new(e,n,r,s,a,o);return v.__wrap(i)}process_input(e){const n=S(e,f.__wbindgen_malloc),r=h,s=f.tuner_process_input(this.__wbg_ptr,n,r);return l(s)}get_wheel_freq(){return f.tuner_get_wheel_freq(this.__wbg_ptr)}get_positions(){const e=f.tuner_get_positions(this.__wbg_ptr);return l(e)}get_apparent_omega(){return f.tuner_get_apparent_omega(this.__wbg_ptr)}get_last_pitch(){return f.tuner_get_last_pitch(this.__wbg_ptr)}update_params(e,n,r,s){f.tuner_update_params(this.__wbg_ptr,e,n,r,s)}get_input_buffer(){const e=f.tuner_get_input_buffer(this.__wbg_ptr);return l(e)}get_output_buffer(){const e=f.tuner_get_output_buffer(this.__wbg_ptr);return l(e)}}async function j(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function B(){const t={};return t.wbg={},t.wbg.__wbindgen_number_new=function(e){return y(e)},t.wbg.__wbindgen_string_new=function(e,n){const r=A(e,n);return y(r)},t.wbg.__wbindgen_object_drop_ref=function(e){l(e)},t.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return y(e)},t.wbg.__wbg_stack_658279fe44541cf6=function(e,n){const r=x(n).stack,s=L(r,f.__wbindgen_malloc,f.__wbindgen_realloc),a=h;M()[e/4+1]=a,M()[e/4+0]=s},t.wbg.__wbg_error_f851667af71bcfc6=function(e,n){let r,s;try{r=e,s=n,console.error(A(e,n))}finally{f.__wbindgen_free(r,s,1)}},t.wbg.__wbg_log_7c3433e130418e14=function(e,n){var r=U(e,n).slice();f.__wbindgen_free(e,n*4,4),console.log(...r)},t.wbg.__wbg_new_ffc6d4d085022169=function(){const e=new Array;return y(e)},t.wbg.__wbg_push_901f3914205d44de=function(e,n){return x(e).push(x(n))},t.wbg.__wbindgen_throw=function(e,n){throw new Error(A(e,n))},t}function I(t,e){return f=t.exports,W.__wbindgen_wasm_module=e,b=null,w=null,d=null,g=null,f}async function W(t){if(f!==void 0)return f;typeof t>"u"&&(t=new URL("/strobe-tuner/assets/strobe_tuner_bg-nJO3TonB.wasm",self.location.href));const e=B();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await j(await t,e);return I(n,r)}class q extends AudioWorkletProcessor{constructor(){super(),this.port.onmessage=e=>this.onmessage(e.data),this.tuner=null,console.log("New Tuner created")}process(e,n){const s=e[0][0];let a=this.tuner?this.tuner.process_input(s):s;for(let o=0;o<a.length;o++)n[0][0][o]=a[o];return!0}onmessage(e){switch(e.type){case"send-wasm-module":W(WebAssembly.compile(e.wasmBytes)).then(()=>{this.port.postMessage({type:"wasm-module-loaded"}),console.log("Loaded WASM module")});break;case"init-tuner":k(),this.tuner=v.new(e.sampleRate,e.wheelFrequency,32,e.filterOn,e.filterOctave,e.filterQ);break;case"get-frame":if(!this.tuner)break;this.port.postMessage({type:"frame",frame:{inputBuffer:this.tuner.get_input_buffer(),outputBuffer:this.tuner.get_output_buffer(),positionBuffer:this.tuner.get_positions(),pitch:this.tuner.get_last_pitch(),apparentOmega:this.tuner.get_apparent_omega()}});break;case"update-settings":this.tuner.update_params(e.wheelFrequency,e.filterOn,e.filterOctave,e.filterQ);break;default:console.error(e.type+" is not a supported message to tuner")}}}registerProcessor("TunerProcessor",q)})();
